#import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime

class TechnicalAnalyzer:
    def apply_moving_average_strategy(self, stock_name, stock_data, window_size=20):
        if not stock_data or len(stock_data) < window_size:
            print("F칬r lite data f칬r att ber칛kna SMA.")
            return

        # Anpassa dataframe till den nya strukturen
        df = pd.DataFrame(stock_data, columns=["Date", "Price", "Volume"])  # Inkludera volym men ignorera den f칬r SMA
        df["Date"] = pd.to_datetime(df["Date"])
        df = df.sort_values("Date")

        df["SMA"] = df["Price"].rolling(window=window_size).mean()

        buy_signals = []
        sell_signals = []
        prev_price, prev_sma = None, None

        for i in range(len(df)):
            if pd.isna(df.loc[i, "SMA"]):
                continue

            price, sma = df.loc[i, "Price"], df.loc[i, "SMA"]

            if prev_price is not None and prev_sma is not None:
                if prev_price < prev_sma and price > sma:
                    buy_signals.append((df.loc[i, "Date"], price))
                elif prev_price > prev_sma and price < sma:
                    sell_signals.append((df.loc[i, "Date"], price))

            prev_price, prev_sma = price, sma

        print(f"\n游늳 K칬p-signaler f칬r {stock_name}:")
        for date, price in buy_signals:
            print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        print(f"\n游늴 S칛lj-signaler f칬r {stock_name}:")
        for date, price in sell_signals:
            print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        plt.figure(figsize=(12, 6))
        plt.plot(df["Date"], df["Price"], marker="o", linestyle="-", label=f"{stock_name} Pris", color="blue")
        plt.plot(df["Date"], df["SMA"], linestyle="--", label=f"{window_size}-dagars SMA", color="red")

        # Markera k칬p- och s칛ljsignaler
        for date, price in buy_signals:
            plt.scatter(date, price, color="green", marker="^", s=150, edgecolors="black", linewidth=1.5,
                        label="K칬p" if "K칬p" not in plt.gca().get_legend_handles_labels()[1] else "")

        for date, price in sell_signals:
            plt.scatter(date, price, color="red", marker="v", s=150, edgecolors="black", linewidth=1.5,
                        label="S칛lj" if "S칛lj" not in plt.gca().get_legend_handles_labels()[1] else "")

        plt.xlabel("Datum")
        plt.ylabel("Pris (SEK)")
        plt.title(f"Glidande medelv칛rde ({window_size}-dagar) f칬r {stock_name}")
        plt.legend()
        plt.grid(True, linestyle="--", alpha=0.6)
        plt.xticks(rotation=45)

        plt.show()

    def calculate_ema(self, prices, period=20):
        """Ber칛knar EMA f칬r en given period."""
        if len(prices) < period:
            print("F칬r f친 datapunkter f칬r att ber칛kna EMA.")
            return []

        ema_values = []
        alpha = 2 / (period + 1)

        # Startv칛rde: SMA f칬r f칬rsta "period" antal dagar
        sma = np.mean(prices[:period])
        ema_values.append(sma)

        # Ber칛kna EMA f칬r resterande dagar
        for price in prices[period:]:
            new_ema = alpha * price + (1 - alpha) * ema_values[-1]
            ema_values.append(new_ema)

        return [None] * (period - 1) + ema_values  # Fyll upp f칬rsta v칛rden med None

    def apply_ema_strategy(self, stock_name, history, period=20):
        """
        Plottar prisutvecklingen och EMA f칬r en aktie med k칬p- och s칛ljsignaler.
        Skriver 칛ven ut signalerna i konsolen i samma format som SMA.
        :param stock_name: Namnet p친 aktien.
        :param history: Lista av tuples (datum, pris, volym).
        :param period: EMA-period.
        """

        if not history or len(history) < period:
            print("Otillr칛ckligt med data f칬r EMA-ber칛kning.")
            return

        # Hantera tre kolumner: (datum, pris, volym), men vi anv칛nder bara datum och pris
        df = pd.DataFrame(history, columns=["Date", "Price", "Volume"])
        df["Date"] = pd.to_datetime(df["Date"])
        df = df.sort_values("Date")

        df["EMA"] = self.calculate_ema(df["Price"], period)

        buy_signals = []
        sell_signals = []

        # Identifiera k칬p- och s칛ljsignaler
        prev_price, prev_ema = None, None
        for i in range(len(df)):
            if pd.isna(df.loc[i, "EMA"]):
                continue  # Hoppa 칬ver perioder d칛r EMA ej ber칛knats

            price, ema = df.loc[i, "Price"], df.loc[i, "EMA"]

            if prev_price is not None and prev_ema is not None:
                if prev_price < prev_ema and price > ema:
                    buy_signals.append((df.loc[i, "Date"], price))  # K칬p

                elif prev_price > prev_ema and price < ema:
                    sell_signals.append((df.loc[i, "Date"], price))  # S칛lj

            prev_price, prev_ema = price, ema

        # Skriv ut signalerna p친 samma s칛tt som i SMA
        print(f"\n游늳 K칬p-signaler f칬r {stock_name}:")
        for date, price in buy_signals:
            print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        print(f"\n游늴 S칛lj-signaler f칬r {stock_name}:")
        for date, price in sell_signals:
            print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        # Plotta grafen
        plt.figure(figsize=(10, 5))
        plt.plot(df["Date"], df["Price"], marker='o', linestyle='-', color='b', label="Pris")
        plt.plot(df["Date"], df["EMA"], linestyle='-', color='r', label=f"EMA ({period} dagar)")

        # Markera k칬p- och s칛ljsignaler i grafen
        for date, price in buy_signals:
            plt.scatter(date, price, marker='^', color='g', s=100, edgecolors="black", linewidth=1.5,
                        label="K칬p" if "K칬p" not in plt.gca().get_legend_handles_labels()[1] else "")

        for date, price in sell_signals:
            plt.scatter(date, price, marker='v', color='r', s=100, edgecolors="black", linewidth=1.5,
                        label="S칛lj" if "S칛lj" not in plt.gca().get_legend_handles_labels()[1] else "")

        # Anpassa utseendet
        plt.xlabel("Datum")
        plt.ylabel("Pris (SEK)")
        plt.title(f"{stock_name} - EMA ({period} dagar) med k칬p-/s칛ljsignaler")
        plt.legend()
        plt.grid(True)
        plt.xticks(rotation=45)
        plt.show()

    def calculate_roc(self, prices, period=14):
        """
        Ber칛knar Rate of Change (ROC) f칬r en given period.
        :param prices: Lista med prisdata.
        :param period: Antal perioder f칬r att ber칛kna ROC (default: 14).
        :return: Lista med ROC-v칛rden.
        """
        if len(prices) < period:
            print("Otillr칛ckligt med data f칬r ROC-ber칛kning.")
            return []

        roc_values = []
        for i in range(period, len(prices)):
            roc = ((prices[i] - prices[i - period]) / prices[i - period]) * 100
            roc_values.append(roc)

        # Fyller b칬rjan med None f칬r att matcha l칛ngden p친 priserna
        return [None] * period + roc_values

    def apply_roc_strategy(self, stock_name, history, period=14):
        """
        Plottar ROC och identifierar k칬p-/s칛ljsignaler.
        :param stock_name: Namnet p친 aktien.
        :param history: Lista av tuples (datum, pris, volym).
        :param period: ROC-period (standard 14 dagar).
        """
        if not history or len(history) < period:
            print("Otillr칛ckligt med data f칬r ROC-ber칛kning.")
            return

        # Hantera tre kolumner: (datum, pris, volym), men vi anv칛nder bara datum och pris
        df = pd.DataFrame(history, columns=["Date", "Price", "Volume"])
        df["Date"] = pd.to_datetime(df["Date"])
        df = df.sort_values("Date")

        # Ber칛kna ROC
        df["ROC"] = self.calculate_roc(df["Price"], period)

        # Ta bort det sista v칛rdet fr친n dates och prices f칬r att matcha l칛ngd p친 roc_values
        dates = df["Date"][:len(df["ROC"])]
        prices = df["Price"][:len(df["ROC"])]
        roc_values = df["ROC"]

        buy_signals = []
        sell_signals = []

        # Identifiera k칬p- och s칛ljsignaler baserat p친 ROC
        for i in range(len(roc_values)):
            if pd.isna(roc_values[i]):
                continue  # Hoppa 칬ver periodens f칬rsta v칛rden (som 칛r NaN)

            if roc_values[i] < 0:  # K칬p n칛r ROC < 0 (pris ned친t)
                buy_signals.append((dates.iloc[i], prices.iloc[i]))

            elif roc_values[i] > 0:  # S칛lj n칛r ROC > 0 (pris upp친t)
                sell_signals.append((dates.iloc[i], prices.iloc[i]))

        # Skriv ut k칬p- och s칛ljsignaler
        if buy_signals:
            print(f"K칬p-signaler f칬r {stock_name}:")
            for date, price in buy_signals:
                print(f"  {date.strftime('%Y-%m-%d')}: {price:.2f} SEK")

        if sell_signals:
            print(f"S칛lj-signaler f칬r {stock_name}:")
            for date, price in sell_signals:
                print(f"  {date.strftime('%Y-%m-%d')}: {price:.2f} SEK")

        # Plotta ROC och k칬p-/s칛ljsignaler
        plt.figure(figsize=(10, 6))
        plt.plot(dates, roc_values, label="ROC", color="blue")

        # Markera k칬p och s칛ljsignaler
        buy_dates, buy_prices = zip(*buy_signals) if buy_signals else ([], [])
        sell_dates, sell_prices = zip(*sell_signals) if sell_signals else ([], [])
        plt.scatter(buy_dates, buy_prices, marker="^", color="green", label="K칬p Signal")
        plt.scatter(sell_dates, sell_prices, marker="v", color="red", label="S칛lj Signal")

        plt.title(f"ROC f칬r {stock_name}")
        plt.xlabel("Datum")
        plt.ylabel("ROC (%)")
        plt.legend()
        plt.grid(True)
        plt.show()

    def apply_obv_strategy(self, stock_name, history):
        """
        Plottar OBV och identifierar k칬p-/s칛ljsignaler baserat p친 OBV-strategi.
        :param stock_name: Namnet p친 aktien.
        :param history: Lista av tuples (datum, pris, volym).
        """
        if not history or len(history) < 2:
            print("Otillr칛ckligt med data f칬r OBV-ber칛kning.")
            return

        # Hantera tre kolumner: (datum, pris, volym)
        df = pd.DataFrame(history, columns=["Date", "Price", "Volume"])
        df["Date"] = pd.to_datetime(df["Date"])
        df = df.sort_values("Date")

        # Ber칛kna OBV
        df["OBV"] = 0
        for i in range(1, len(df)):
            if df["Price"].iloc[i] > df["Price"].iloc[i - 1]:  # Om priset stiger
                df["OBV"].iloc[i] = df["OBV"].iloc[i - 1] + df["Volume"].iloc[i]
            elif df["Price"].iloc[i] < df["Price"].iloc[i - 1]:  # Om priset faller
                df["OBV"].iloc[i] = df["OBV"].iloc[i - 1] - df["Volume"].iloc[i]
            else:  # Om priset 칛r of칬r칛ndrat
                df["OBV"].iloc[i] = df["OBV"].iloc[i - 1]

        # Identifiera k칬p- och s칛ljsignaler baserat p친 OBV
        buy_signals = []
        sell_signals = []

        for i in range(1, len(df)):
            if df["OBV"].iloc[i] > df["OBV"].iloc[i - 1]:  # OBV 칬kar, k칬p-signal
                buy_signals.append((df["Date"].iloc[i], df["Price"].iloc[i]))
            elif df["OBV"].iloc[i] < df["OBV"].iloc[i - 1]:  # OBV minskar, s칛lj-signal
                sell_signals.append((df["Date"].iloc[i], df["Price"].iloc[i]))

        # Skriv ut k칬p- och s칛ljsignaler
        if buy_signals:
            print(f"\n游늳 K칬p-signaler f칬r {stock_name}:")
            for date, price in buy_signals:
                print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        if sell_signals:
            print(f"\n游늴 S칛lj-signaler f칬r {stock_name}:")
            for date, price in sell_signals:
                print(f"   - {date.strftime('%Y-%m-%d')} till pris {price:.2f} SEK")

        # Plotta OBV och k칬p-/s칛ljsignaler
        plt.figure(figsize=(12, 6))
        plt.plot(df["Date"], df["OBV"], label="OBV", color="purple")

        # Markera k칬p och s칛ljsignaler
        buy_dates, buy_prices = zip(*buy_signals) if buy_signals else ([], [])
        sell_dates, sell_prices = zip(*sell_signals) if sell_signals else ([], [])
        plt.scatter(buy_dates, buy_prices, marker="^", color="green", label="K칬p-signal", s=100)
        plt.scatter(sell_dates, sell_prices, marker="v", color="red", label="S칛lj-signal", s=100)

        # Anpassa utseendet
        plt.title(f"OBV f칬r {stock_name}")
        plt.xlabel("Datum")
        plt.ylabel("OBV")
        plt.legend()
        plt.grid(True)
        plt.xticks(rotation=45)
        plt.show()

